var Follow=pc.createScript("follow");Follow.attributes.add("target",{type:"entity",title:"Target",description:"The Entity to follow"}),Follow.attributes.add("distance",{type:"number",default:4,title:"Distance",description:"How far from the Entity should the follower be"}),Follow.prototype.initialize=function(){this.vec=new pc.Vec3},Follow.prototype.update=function(t){if(this.target){var e=this.target.getPosition();e.x+=.75*this.distance,e.y+=1*this.distance,e.z+=.75*this.distance,this.vec.lerp(this.vec,e,.1),this.entity.setPosition(this.vec)}};var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1,min:.05,max:.5,precision:2,description:"Controls the movement speed"}),Movement.prototype.initialize=function(){this.force=new pc.Vec3},Movement.prototype.update=function(e){var t=0,s=0;if(this.app.keyboard.isPressed(pc.KEY_LEFT)&&(t=-this.speed),this.app.keyboard.isPressed(pc.KEY_RIGHT)&&(t+=this.speed),this.app.keyboard.isPressed(pc.KEY_UP)&&(s=-this.speed),this.app.keyboard.isPressed(pc.KEY_DOWN)&&(s+=this.speed),this.force.x=t,this.force.z=s,this.force.length()){var i=Math.cos(.25*-Math.PI),o=Math.sin(.25*-Math.PI);this.force.set(this.force.x*i-this.force.z*o,0,this.force.z*i+this.force.x*o),this.force.length()>this.speed&&this.force.normalize().scale(this.speed)}this.entity.rigidbody.applyImpulse(this.force)};var Teleportable=pc.createScript("teleportable");Teleportable.prototype.initialize=function(){this.lastTeleportFrom=null,this.lastTeleportTo=null,this.lastTeleport=Date.now(),this.startPosition=this.entity.getPosition().clone()},Teleportable.prototype.update=function(t){this.entity.getPosition().y<0&&this.teleport(this.lastTeleportFrom,this.lastTeleportTo)},Teleportable.prototype.teleport=function(t,e){var o;t&&Date.now()-this.lastTeleport<500||(this.lastTeleport=Date.now(),this.lastTeleportFrom=t,this.lastTeleportTo=e,e?(o=e.getPosition()).y+=.5:o=this.startPosition,this.entity.rigidbody.teleport(o),this.entity.rigidbody.linearVelocity=pc.Vec3.ZERO,this.entity.rigidbody.angularVelocity=pc.Vec3.ZERO)};var Teleport=pc.createScript("teleport");Teleport.attributes.add("target",{type:"entity",title:"Target Entity",description:"The target entity where we are going to teleport"}),Teleport.prototype.initialize=function(){this.target&&this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},Teleport.prototype.onTriggerEnter=function(t){t.script.teleportable&&t.script.teleportable.teleport(this.entity,this.target)};var PlayerControl=pc.createScript("playerControl");PlayerControl.attributes.add("speed",{type:"number",default:1,min:.5,max:5,precision:2,description:"Controls the movement speed"});var CHAR_IDLE=0,CHAR_WALK=1,CHAR_START=2,CHAR_LTURN=3;PlayerControl.prototype.initialize=function(){this.force=new pc.Vec3,this.rotSpeed=.25;this.minDist=1.25,this.maxDist=5,this.xoffset=0,this.maxYoffset=.3,this.minYoffset=.3;var t=this.app,s=(this.entity,t.root.findByName("MainCamera")),e=t.root.findByName("CameraFocus"),i=new pc.GraphNode;e.addChild(i),i.setLocalPosition(this.xoffset,0,this.maxDist),this.dist=this.maxDist,s.setPosition(i.getPosition()),s.setRotation(i.getRotation()),this.pivot=e,this.camPoint=i,this.camNode=s,this.tmpVec=new pc.Vec3,this.moveVec=new pc.Vec3,this.tmpQuat=new pc.Quat,this.state=CHAR_IDLE,this.anims=["chartest_idle_full.json","chartest_nomove_cloth.json","chartest_turn180L.json","chartest_leftturn.json"],this.stateStart=0,this.stateStartDist=this.maxDist,this.tmpRot=new pc.Quat,this.yaw=0,this.pitch=0,this.persistentPos=new pc.Vec3,this.persistentQuat=new pc.Quat,t.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),t.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),t.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.lmbDown=!1},PlayerControl.prototype.onMouseDown=function(t){this.lmbDown=!0,pc.Mouse.isPointerLocked()||this.app.mouse.enablePointerLock()},PlayerControl.prototype.onMouseUp=function(t){this.lmbDown=!1},PlayerControl.prototype.onMouseMove=function(t){this.lmbDown&&(this.entity.rotateLocal(0,-t.dx*this.rotSpeed,0),this.pitch+=-t.dy*this.rotSpeed,this.pitch=pc.math.clamp(this.pitch,-60,60),this.pivot.setLocalEulerAngles(this.pitch,0,0))},PlayerControl.prototype.updateCamera=function(t){var s=this.camPoint,e=this.camNode;e.setPosition(s.getPosition()),e.setRotation(s.getRotation())},PlayerControl.prototype.update=function(t){var s=this.app,e=(this.pivot,this.camPoint),i=this.camNode,o=this.entity,a=this.moveVec,n=this.tmpVec,r=!1;a.set(0,0,0),this.lockControls||(s.keyboard.isPressed(pc.KEY_W)||s.keyboard.isPressed(pc.KEY_UP)||this.F_Pressed?(a.add(i.forward),r=!0):(s.keyboard.isPressed(pc.KEY_S)||s.keyboard.isPressed(pc.KEY_DOWN)||this.BW_Pressed)&&(a.sub(i.forward),r=!0),s.keyboard.isPressed(pc.KEY_A)||s.keyboard.isPressed(pc.KEY_LEFT)||this.L_Pressed?this.entity.rotateLocal(0,-1*this.rotSpeed,0):(s.keyboard.isPressed(pc.KEY_D)||s.keyboard.isPressed(pc.KEY_RIGHT)||this.R_Pressed)&&this.entity.rotateLocal(0,1*this.rotSpeed,0),a.y=0,a.normalize().scale(1.45),s.keyboard.isPressed(pc.KEY_SHIFT)&&a.scale(1.5*(this.collision?1:2)));var h=r?CHAR_WALK:CHAR_IDLE;if(this.state!==h&&(this.stateStart=pc.now(),this.stateStartDist=this.dist,this.state=h),h===CHAR_WALK){var c=1;c*=c,o.translate(a.scale(this.speed*t*c)),this.collision&&(this.navClosestPos(n,o.getPosition()),o.setPosition(n))}this.lockCamera||(i.setPosition(e.getPosition()),i.setRotation(e.getRotation()))};var TheTouchJoy=pc.createScript("theTouchJoy");TheTouchJoy.attributes.add("handle",{type:"entity",default:null,title:"Handle"}),TheTouchJoy.attributes.add("FirstPos",{type:"vec3"}),TheTouchJoy.prototype.initialize=function(){this.FirstPos=this.entity.getLocalPosition()};var deltaTime=0;TheTouchJoy.prototype.postInitialize=function(){if(this.handle||(this.handle=this.entity),!this.handle)throw new Error("JoyStickRight has no handle");this.addHandleListeners(),this.isDragging=!1,this.touchId=-1,this.mousePos=new pc.Vec3,this.anchorPos=this.handle.getLocalPosition().clone(),this.screen=this.getUIScreenComponent(),this.Target=this.app.root.findByName("Player"),this.axis="xy"},TheTouchJoy.prototype.getUIScreenComponent=function(){return this.handle.element.screen.screen},TheTouchJoy.prototype.addHandleListeners=function(){this.handle.element.useInput=!0,this.handle.element.on(pc.EVENT_MOUSEDOWN,this.onPressDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onPressUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onPressMove,this),this.app.touch&&(console.log("initing touches"),this.handle.element.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.app.touch.on(pc.EVENT_TOUCHCANCEL,this.onTouchEnd,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this)),this.on("destroy",(function(){this.handle.element.off(pc.EVENT_MOUSEDOWN,this.onPressDown,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onPressUp,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onPressMove,this),this.app.touch&&(this.handle.element.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchEnd,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this))}))},TheTouchJoy.prototype.onTouchStart=function(t){var e=t.changedTouches[0];this.touchId=e.identifier,this.startDrag(t.x,t.y),t.event.stopPropagation()},TheTouchJoy.prototype.onTouchMove=function(t){for(var e=0;e<t.changedTouches.length;e++){var o=t.changedTouches[e];if(o.id==this.touchId)return t.event.stopPropagation(),void this.updateMove(o.x,o.y)}},TheTouchJoy.prototype.onTouchEnd=function(t){for(var e=0;e<t.changedTouches.length;e++){var o=t.changedTouches[e];if(o.id==this.touchId)return t.event.stopImmediatePropagation(),this.touchId=-1,void this.endDrag(o.x,o.y)}},TheTouchJoy.prototype.onPressDown=function(t){t.event.stopImmediatePropagation(),this.startDrag(t.x,t.y)},TheTouchJoy.prototype.onPressUp=function(t){t.event.stopImmediatePropagation(),this.endDrag(t.x,t.y)},TheTouchJoy.prototype.onPressMove=function(t){this.updateMove(t.x,t.y),t.event.stopImmediatePropagation()},TheTouchJoy.prototype.startDrag=function(t,e){this.isDragging=!0,this.setMouseXY(t,e)},TheTouchJoy.prototype.updateMove=function(t,e){this.isDragging&&this.setMouseXY(t,e)},TheTouchJoy.prototype.endDrag=function(t,e){this.isDragging=!1,this.setMouseXY(t,e),this.handle.setLocalPosition(this.anchorPos),this.Target.script.playerControl.L_Pressed=!1,this.Target.script.playerControl.R_Pressed=!1,this.Target.script.playerControl.F_Pressed=!1,this.Target.script.playerControl.BW_Pressed=!1},TheTouchJoy.prototype.setMouseXY=function(t,e){this.mousePos.x=t,this.mousePos.y=e},TheTouchJoy.prototype.update=function(t){deltaTime=t,this.updateDrag()};var cursorPosition=new pc.Vec3(0,0,0),maxLength=.5;TheTouchJoy.prototype.LimitInCircle=function(t,e,o){var s=new pc.Vec3(0,0,0),i=(s=s.sub2(t,e)).length(),h=new pc.Vec3(0,0,0);return h=s.scale(1/i),cursorPosition=i>o?cursorPosition.add2(e,h.scale(o)):t},TheTouchJoy.prototype.Horizontal=function(t){return new pc.Vec3(1,0,0).mul(t)},TheTouchJoy.prototype.Vertical=function(t){return new pc.Vec3(0,1,0).mul(t)},TheTouchJoy.prototype.updateDrag=function(){if(this.isDragging){var t=this.app.graphicsDevice,e=this.handle.element.anchor.x*t.width,o=this.handle.element.anchor.y*t.height,s=1/this.screen.scale,i="x"==this.axis||"xy"==this.axis?(this.mousePos.x-e)*s:this.anchorPos.x,h="y"==this.axis||"xy"==this.axis?(-this.mousePos.y+o)*s:this.anchorPos.y,n=this.LimitInCircle(new pc.Vec3(i,h,0),this.FirstPos,110),r=new pc.Vec3(0,0,0),a=(r=r.sub2(this.Horizontal(this.FirstPos),this.Horizontal(n))).length()/110,c=new pc.Vec3(0,0,0),p=(c=c.sub2(this.Vertical(this.FirstPos),this.Vertical(n))).length()/110;n.x<this.FirstPos.x&&(a*=-1),n.y<this.FirstPos.y&&(p*=-1);var u=Math.atan2(p,a)*(180/3.14);this.Target.getEulerAngles();this.Target.script.playerControl.L_Pressed=!1,this.Target.script.playerControl.R_Pressed=!1,this.Target.script.playerControl.F_Pressed=!1,this.Target.script.playerControl.BW_Pressed=!1,(u>135||u<-135)&&(this.Target.script.playerControl.L_Pressed=!1,this.Target.script.playerControl.R_Pressed=!0),u<45&&u>-45&&(this.Target.script.playerControl.R_Pressed=!1,this.Target.script.playerControl.L_Pressed=!0),u>=45&&u<=135&&(this.Target.script.playerControl.F_Pressed=!0,this.Target.script.playerControl.BW_Pressed=!1),u<=-45&&u>=-135&&(this.Target.script.playerControl.BW_Pressed=!0,this.Target.script.playerControl.F_Pressed=!1),this.handle.setLocalPosition(n)}};